---
import type { CollectionEntry } from 'astro:content';
import BaseHead from '../components/BaseHead.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import FormattedDate from '../components/FormattedDate.astro';
import { Image } from 'astro:assets';
import mpaViewTransitions from '../assets/insights/mpa-view-transitions.png';
import blogPlaceholder1 from '../assets/insights/blog-placeholder-1.jpg';
import blogPlaceholder2 from '../assets/insights/blog-placeholder-2.jpg';
import blogPlaceholder3 from '../assets/insights/blog-placeholder-3.jpg';
import blogPlaceholder4 from '../assets/insights/blog-placeholder-4.jpg';
import blogPlaceholder5 from '../assets/insights/blog-placeholder-5.jpg';
import blogPlaceholderAbout from '../assets/insights/blog-placeholder-about.jpg';
import designCoverRaw from '../assets/insights/design-cover-raw.jpg';
import { SITE_TITLE, SITE_DESCRIPTION } from '../consts';

type Props = CollectionEntry<'insights'>['data'];

const { title, description, pubDate, updatedDate, heroImage, isPrivate } = Astro.props;

const heroImageMap = {
  '/assets/insights/mpa-view-transitions.png': mpaViewTransitions,
  '/assets/insights/blog-placeholder-1.jpg': blogPlaceholder1,
  '/assets/insights/blog-placeholder-2.jpg': blogPlaceholder2,
  '/assets/insights/blog-placeholder-3.jpg': blogPlaceholder3,
  '/assets/insights/blog-placeholder-4.jpg': blogPlaceholder4,
  '/assets/insights/blog-placeholder-5.jpg': blogPlaceholder5,
  '/assets/insights/blog-placeholder-about.jpg': blogPlaceholderAbout,
  '/assets/insights/design-cover-raw.jpg': designCoverRaw,
};
const image = heroImage ? heroImageMap[heroImage] : undefined;
---

<html lang="en">
  <head>
    <BaseHead title={title || SITE_TITLE} description={description || SITE_DESCRIPTION} />
    <style>
      main {
        width: calc(100% - 2em);
        max-width: 100%;
        margin: 0;
      }
      .hero-image {
        width: 100%;
        max-width: 720px;
        margin: 0 auto 2rem auto;
      }
      .hero-image img, .hero-image picture {
        display: block;
        width: 100%;
        height: auto;
        border-radius: 12px;
        box-shadow: var(--box-shadow);
        max-width: 100%;
      }
      .prose {
        width: 720px;
        max-width: calc(100% - 2em);
        margin: auto;
        padding: 1em;
        color: rgb(var(--gray-dark));
      }
      .paywall {
        position: relative;
        margin-top: 1.5rem;
      }
      .paywall .blurred {
        filter: blur(6px);
        mask-image: linear-gradient(to bottom, rgba(0,0,0,1) 0%, rgba(0,0,0,1) 60%, rgba(0,0,0,0) 100%);
        -webkit-mask-image: linear-gradient(to bottom, rgba(0,0,0,1) 0%, rgba(0,0,0,1) 60%, rgba(0,0,0,0) 100%);
        pointer-events: none;
        user-select: none;
        max-height: 40vh;
        overflow: hidden;
      }
      .paywall .overlay {
        position: relative;
        border: 1px solid rgb(var(--gray-light));
        border-radius: 12px;
        padding: 1rem;
        background: #fff;
        box-shadow: 0 2px 6px rgba(0,0,0,.05);
      }
      .paywall form { display: grid; gap: .75rem; margin-top: 1rem; }
      .paywall input[type="email"] { padding: .75rem; border:1px solid rgb(var(--gray-light)); border-radius:8px; }
      .paywall button { padding:.75rem 1rem; border-radius:999px; background: var(--accent); border:none; font-weight:600; }
      .title {
        margin-bottom: 1em;
        padding: 1em 0;
        text-align: center;
        line-height: 1;
      }
      .title h1 {
        margin: 0 0 0.5em 0;
      }
      .date {
        margin-bottom: 0.5em;
        color: rgb(var(--gray));
      }
      .last-updated-on {
        font-style: italic;
      }
      .tags {
          display: flex;
          flex-wrap: wrap;
          gap: 0.5rem;
          justify-content: center;
          margin-top: 1rem;
      }
      .tag {
          display: inline-block;
          padding: 0.25rem 0.75rem;
          border-radius: 15px;
          background-color: var(--gray-light);
          color: var(--gray-dark);
          font-size: 0.8rem;
          text-decoration: none;
      }
      .tag:hover {
          background-color: var(--accent);
          color: white;
      }
    </style>
  </head>
  <body>
    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-M5HXRM4X" height="0" width="0" style="display: none; visibility: hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->
    <Header />
    <main>
      <article>
        <div class="hero-image">
          {image && (
            <Image src={image} alt={`Cover image for: ${title}`} width={720} height={360} style="width:100%;height:auto;border-radius:12px;box-shadow:var(--box-shadow);" />
          )}
        </div>
        <div class="prose">
          <div class="title">
            <div class="date">
              <FormattedDate date={pubDate} />
              { updatedDate && (
              <div class="last-updated-on">
                Last updated on <FormattedDate date={updatedDate} />
              </div>
              ) }
            </div>
            <h1>{title}</h1>
            <div class="tags">
                {Astro.props.tags?.map(tag => (
                    <a href={`/tags/${tag}`} class="tag">{tag}</a>
                ))}
            </div>
            <hr />
          </div>
          {isPrivate ? (
            <div class="paywall">
              <div class="blurred">
                <slot />
              </div>
              <div class="overlay">
                <h3>Become a member to read this story, and all of Olha Insights.</h3>
                <p>Itâ€™s available to read with a free membership. Benefits include access to member-only stories and the ability to comment.</p>
                <form method="post" action="https://formspree.io/f/mzbldgwr">
                  <label for="email">Enter your email to read the full article</label>
                  <input id="email" name="email" type="email" placeholder="you@example.com" required />
                  <label style="display:flex; gap:.5rem; align-items:center;">
                    <input type="checkbox" name="subscribe" checked /> Subscribe
                  </label>
                  <input type="hidden" name="_subject" value="New reader signup (Insights)" />
                  <input type="hidden" name="post" value={title} />
                  <button type="submit">Continue</button>
                </form>
              </div>
            </div>
          ) : (
            <slot />
          )}
        </div>
      </article>
    </main>
    <Footer />
  </body>
</html>
